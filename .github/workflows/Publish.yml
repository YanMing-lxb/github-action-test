name: Publish RHS 🐍

on:
  push:
    tags:
      - v*.*.*  # 当推送以v开头的标签时触发此工作流

jobs:
  publish:
    name: Build and Publish RefrTruck HeatLoad Solver
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up 🐍 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install Inno Setup
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
          $installerPath = "$env:TEMP\innosetup-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait

          # 将 Inno Setup 添加到 PATH 环境变量
          [Environment]::SetEnvironmentVariable(
            "PATH", 
            "$env:PATH;C:\Program Files (x86)\Inno Setup 6", 
            [EnvironmentVariableTarget]::Process
          )
        shell: pwsh

      - name: Build 📦 source
        run: |
          cd ${{ github.workspace }}
          $env:PYTHONIOENCODING = "utf-8"
          python3 -m pip install --upgrade rich
          # python ${{ github.workspace }}\tools\pack.py pack
          python ${{ github.workspace }}\tools\pack.py setup

        shell: pwsh

      - name: Extract tag name
        id: extract_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Generate Changelog
        run: |
          # Read the content of CHANGELOG.md
          changelog=$(cat "${GITHUB_WORKSPACE}/CHANGELOG.md")
          
          # Get the tag name
          tag_name="${TAG_NAME}"
          
          # Find the section matching the tag name and extract it
          version_header="## $tag_name"
          if [[ "$changelog" == *"$version_header"* ]]; then
            # Extract the content under the version header until the next '##' header
            version_content=$(echo "$changelog" | awk -v version_header="$version_header" '
              $0 ~ version_header { p=1; next }
              /^## / && p { exit }
              p')
            echo "$version_content"
            # Write the extracted content to a new file
            echo "$version_content" > "${GITHUB_WORKSPACE}-CHANGELOG.txt"
          else
            echo "Version $tag_name not found in CHANGELOG.md"
          fi
        shell: pwsh

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          token: ${{ secrets.GA_TEST }}
          name: RefrTruck HeatLoad Solver ${{ github.ref_name }}
          files: dist/*.exe