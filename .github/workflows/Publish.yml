name: Publish RHS 🐍

on:
  push:
    tags:
      - v*.*.*  # 当推送以v开头的标签时触发此工作流

jobs:
  publish:
    name: Build and Publish RefrTruck HeatLoad Solver
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up 🐍 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install Inno Setup
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
          $installerPath = "$env:TEMP\innosetup-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait

          # 将 Inno Setup 添加到 PATH 环境变量
          [Environment]::SetEnvironmentVariable(
            "PATH", 
            "$env:PATH;C:\Program Files (x86)\Inno Setup 6", 
            [EnvironmentVariableTarget]::Process
          )
        shell: pwsh

      - name: Build 📦 source
        run: |
          cd ${{ github.workspace }}
          $env:PYTHONIOENCODING = "utf-8"
          python3 -m pip install --upgrade rich
          python ${{ github.workspace }}\tools\pack.py pack
          python ${{ github.workspace }}\tools\pack.py setup

        shell: pwsh

      - name: Extract tag name
        id: extract_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Generate Changelog
        run: |
          $changelog = Get-Content -Path "${{ github.workspace }}\CHANGELOG.md" -Raw
          $tag_name = $env:TAG_NAME
          $version_header = "## $tag_name"

          if ($changelog -like "*$version_header*") {
            $start = $changelog.IndexOf($version_header)
            $end = $changelog.IndexOf("## ", $start + 1)
            if ($end -eq -1) { $end = $changelog.Length }
            $version_content = $changelog.Substring($start, $end - $start)
            Write-Output $version_content
            $version_content | Out-File "${{ github.workspace }}-CHANGELOG.txt"
          } else {
            Write-Output "Version $tag_name not found in CHANGELOG.md"
          }
        shell: pwsh

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          token: ${{ secrets.GA_TEST }}
          name: RefrTruck HeatLoad Solver ${{ github.ref_name }}
          files: dist/*.exe