name: Publish RHS 🐍

on:
  push:
    tags:
      - v*.*.*  # 当推送以v开头的标签时触发此工作流

jobs:
  publish:
    name: Build and Publish RefrTruck HeatLoad Solver
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up 🐍 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install Inno Setup
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
          $installerPath = "$env:TEMP\innosetup-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait

          # 将 Inno Setup 添加到 PATH 环境变量
          [Environment]::SetEnvironmentVariable(
            "PATH", 
            "$env:PATH;C:\Program Files (x86)\Inno Setup 6", 
            [EnvironmentVariableTarget]::Process
          )
        shell: pwsh

      - name: Build 📦 source
        run: |
          cd ${{ github.workspace }}
          $env:PYTHONIOENCODING = "utf-8"
          python3 -m pip install --upgrade rich
          # python ${{ github.workspace }}\tools\pack.py pack
          python ${{ github.workspace }}\tools\pack.py setup

        shell: pwsh

      - name: Extract tag name
        id: extract_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Generate Changelog
        run: |
          # Read the content of CHANGELOG.md
          $changelog = Get-Content -Path "${env:GITHUB_WORKSPACE}\CHANGELOG.md" -Raw

          # Get the tag name
          $tag_name = "${env:TAG_NAME}"

          # Define version header
          $version_header = "## $tag_name"

          # Check if changelog contains the version header
          if ($changelog -like "*$version_header*") {
              # Extract content between this version header and next one
              $lines = $changelog -split [environment]::NewLine
              $startIndex = $lines.IndexOf($version_header) + 1
              if ($startIndex -lt 0) {
                  Write-Output "Version header not found"
                  exit 1
              }

              $endIndex = $lines.Length
              for ($i = $startIndex; $i -lt $lines.Length; $i++) {
                  if ($lines[$i] -match "^## .+") {
                      $endIndex = $i
                      break
                  }
              }

              $version_content = $lines[$startIndex..($endIndex - 1)]

              # Output and write to file
              $version_content | Out-String | Write-Output
              $version_content | Out-File -FilePath "${env:GITHUB_WORKSPACE}-CHANGELOG.txt" -Encoding utf8
          } else {
              Write-Output "Version $tag_name not found in CHANGELOG.md"
              exit 1
          }
        shell: pwsh
        
      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          token: ${{ secrets.GA_TEST }}
          name: RefrTruck HeatLoad Solver ${{ github.ref_name }}
          files: dist/*.exe